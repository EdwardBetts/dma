Description: Allow the spool to be on a filesystem that does not set d_type.
 Some filesystems (notably XFS) do not set the d_type field in the dirent
 structure.  This prevents dma from delivering any of the queued messages.
 I'll forward this patch when I catch up with the dma upstream.
Origin: other: http://svn.ringlet.net/svn/ringlet/mail/dma/
Bug-Debian: http://bugs.debian.org/544357
Forwarded: no
Author: Peter Pentchev <roam@ringlet.net>
Last-Update: 2009-09-01

--- a/dma.c
+++ b/dma.c
@@ -1416,10 +1416,20 @@
 
 		/* ignore temp files */
 		if (strncmp(de->d_name, "tmp_", 4) == 0 ||
-		    de->d_type != DT_REG)
+		    (de->d_type != DT_REG && de->d_type != DT_UNKNOWN))
 			continue;
 		if (asprintf(&queuefn, "%s/%s", config->spooldir, de->d_name) < 0)
 			goto fail;
+		if (de->d_type == DT_UNKNOWN) {
+			if (stat(queuefn, &st) == -1) {
+				free(queuefn);
+				goto fail;
+			}
+			if (!S_ISREG(st.st_mode)) {
+				free(queuefn);
+				continue;
+			}
+		}
 		seenit = seen(de->d_name);
 		if (inmore && seenit) {
 			free(queuefn);
